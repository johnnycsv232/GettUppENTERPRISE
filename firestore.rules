rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
      
      // User subscription data
      match /subscriptions/{subId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isAdmin(); // Only server-side via webhook
      }
    }
    
    // ============================================
    // Leads Collection - Public create, Admin manage
    // ============================================
    match /leads/{leadId} {
      allow create: if hasRequiredFields(['email', 'name', 'createdAt'])
                   && isValidEmail(request.resource.data.email)
                   && request.resource.data.createdAt == request.time;
      allow read, update, delete: if isAdmin();
    }
    
    // ============================================
    // Clients Collection - Admin only
    // ============================================
    match /clients/{clientId} {
      allow read: if isAdmin() || isOwner(clientId);
      allow write: if isAdmin();
      
      // Client projects
      match /projects/{projectId} {
        allow read: if isAdmin() || isOwner(clientId);
        allow write: if isAdmin();
      }
      
      // Client content deliveries
      match /deliveries/{deliveryId} {
        allow read: if isAdmin() || isOwner(clientId);
        allow write: if isAdmin();
      }
    }
    
    // ============================================
    // Payments Collection - Stripe webhook only
    // ============================================
    match /payments/{paymentId} {
      allow read: if isAdmin() || 
                  (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if false; // Only server-side via Stripe webhook
    }
    
    // ============================================
    // Subscriptions Collection - Stripe webhook only
    // ============================================
    match /subscriptions/{subId} {
      allow read: if isAdmin() || 
                  (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if false; // Only server-side via Stripe webhook
    }
    
    // ============================================
    // Agent Tasks Collection - Server-side only
    // ============================================
    match /agent_tasks/{taskId} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side via authenticated API
    }
    
    // ============================================
    // Site Content - Public read, Admin write
    // ============================================
    match /site_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // Knowledge Base - Admin only
    // ============================================
    match /knowledge_base/{docId} {
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // Invoices - Admin and invoice owner
    // ============================================
    match /invoices/{invoiceId} {
      allow read: if isAdmin() || 
                  (isAuthenticated() && resource.data.clientId == request.auth.uid);
      allow write: if isAdmin();
    }
    
    // ============================================
    // Analytics - Public write for tracking, Admin read
    // ============================================
    match /analytics/{eventId} {
      allow create: if hasRequiredFields(['event', 'timestamp'])
                   && request.resource.data.timestamp == request.time;
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // ============================================
    // Calendar Bookings - Cal.com integration
    // ============================================
    match /bookings/{bookingId} {
      allow read: if isAdmin() || 
                  (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if false; // Only server-side via Cal.com webhook
    }
    
    // ============================================
    // Content Gallery - Public read, Admin manage
    // ============================================
    match /gallery/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // Testimonials - Public read, Admin manage
    // ============================================
    match /testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    // ============================================
    // God Mode 2.0 - Shoots & Photos (Dual-write)
    // ============================================
    match /shoots/{shootId} {
      allow read: if true; // Public for QR delivery logic
      allow write: if isAdmin();
    }

    match /photos/{photoId} {
      allow read: if true; // Public through QR codes (protected by UUID)
      allow write: if isAdmin();
    }
  }
}
